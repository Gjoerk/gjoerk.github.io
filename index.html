<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 TradeUp Engine</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        .form-control {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #fff;
        }
        .form-control:focus {
            background-color: #333;
            color: #fff;
            border-color: #666;
            box-shadow: none;
        }
        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }
        
        /* Status Farben für die neue Logik */
        .text-jackpot { color: #ff00de; font-weight: bold; } /* Pink */
        .text-profit { color: #00ff00; font-weight: bold; }  /* Grün */
        .text-loss { color: #888888; }                       /* Grau */

        .outcome-row {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
        }
        .outcome-row:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div class="container py-5">
        <h1 class="text-center mb-4">CS2 TradeUp Engine</h1>

        <div class="card p-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Max Budget (€)</label>
                    <input type="number" id="max-budget" class="form-control" value="10">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Min Yield (%)</label>
                    <input type="number" id="min-roi" class="form-control" value="10">
                    <div style="font-size: 0.7em; color: #888;">(10 = 10% Profit)</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Float Buffer</label>
                    <input type="number" id="float-buffer" class="form-control" value="0.001" step="0.001">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Price Factor</label>
                    <input type="number" id="price-factor" class="form-control" value="0.95" step="0.01">
                </div>
                <div class="col-12 text-end">
                    <button class="btn btn-primary px-4" onclick="startCalculation()">Run Simulation</button>
                </div>
            </div>
            <div id="status-msg" class="text-end mt-2" style="font-size: 0.8em; color: #888;">Loading data...</div>
        </div>

        <div id="results-container"></div>
    </div>

    <script>
        let database = [];
        let prices = {};

        // --- 1. AUTO LOAD & SAVE (LocalStorage) ---
        window.onload = async function() {
            initSettings(); // Erst Inputs wiederherstellen
            await loadFiles(); // Dann Daten laden
        };

        function initSettings() {
            const fields = ['max-budget', 'min-roi', 'float-buffer', 'price-factor'];
            fields.forEach(id => {
                const element = document.getElementById(id);
                // Laden
                const savedValue = localStorage.getItem(id);
                if (savedValue !== null) element.value = savedValue;
                // Speichern
                element.addEventListener('input', function() {
                    localStorage.setItem(id, this.value);
                });
            });
        }

        async function loadFiles() {
            try {
                const dbReq = await fetch('database.json');
                database = await dbReq.json();

                const priceReq = await fetch('prices_cache.json');
                prices = await priceReq.json();

                document.getElementById('status-msg').innerText = 'Data Ready';
                document.getElementById('status-msg').style.color = '#00ff00';
            } catch (error) {
                console.error(error);
                document.getElementById('status-msg').innerText = 'Error loading files';
                document.getElementById('status-msg').style.color = 'red';
            }
        }

        function startCalculation() {
            if(!database || Object.keys(prices).length === 0) { 
                alert("Datenbank noch nicht geladen!"); 
                return; 
            }
            
            const MAX_COST = parseFloat(document.getElementById('max-budget').value);
            
            // --- 2. FILTER LOGIK (+100) ---
            // Wenn User "10" eingibt, meint er 10% Profit -> Filter auf 110% Yield
            let inputRoi = parseFloat(document.getElementById('min-roi').value);
            const MIN_ROI = inputRoi + 100;

            const BUFFER = parseFloat(document.getElementById('float-buffer').value);
            const FACTOR = parseFloat(document.getElementById('price-factor').value);

            const container = document.getElementById('results-container');
            container.innerHTML = '<div class="text-center mt-5 text-muted">Calculating...</div>';

            setTimeout(() => {
                let results = [];

                database.forEach(collection => {
                    collection.inputs.forEach(inputSkin => {
                        let inputPrice = prices[inputSkin.name];
                        if(!inputPrice) return;

                        let realInputPrice = inputPrice * FACTOR; 
                        let totalCost = realInputPrice * 10;
                        
                        if(totalCost > MAX_COST) return;

                        let simulation = runSimulation(collection, inputSkin, realInputPrice, BUFFER);
                        
                        if(simulation && simulation.roi >= MIN_ROI) {
                            results.push(simulation);
                        }
                    });
                });

                renderResults(results);
            }, 50);
        }

        function runSimulation(collection, inputSkin, singleInputPrice, buffer) {
            let outcomes = [];
            let totalEv = 0;
            
            let avgFloat = (inputSkin.min_float + buffer); 
            let possibleOutputs = collection.outputs.filter(o => o.rarity === nextRarity(inputSkin.rarity));
            
            if(possibleOutputs.length === 0) return null;

            possibleOutputs.forEach(outSkin => {
                let outFloat = (avgFloat * (outSkin.max_float - outSkin.min_float)) + outSkin.min_float;
                let condition = getCondition(outFloat);
                let priceName = condition ? `${outSkin.name} (${condition})` : outSkin.name;
                
                let outPrice = prices[priceName] || 0;
                let prob = 1 / possibleOutputs.length; 

                outcomes.push({ name: priceName, price: outPrice, float: outFloat });
                totalEv += (outPrice * prob);
            });

            if(totalEv === 0) return null;
            let cost = singleInputPrice * 10;
            
            // --- 3. NEUE ROI FORMEL (YIELD) ---
            let roi = (totalEv / cost) * 100; // Ergebnis z.B. 110.5

            return {
                inputName: inputSkin.name,
                cost: cost,
                ev: totalEv,
                roi: roi,
                outcomes: outcomes
            };
        }

        function renderResults(results) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';

            if(results.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">Keine Ergebnisse gefunden.</div>';
                return;
            }

            results.sort((a, b) => b.roi - a.roi);

            results.slice(0, 50).forEach(res => {
                
                // --- 4. NEUE FARB LOGIK ---
                let isJackpot = res.roi > 130;  // Über 30% Profit
                let isProfit = res.roi >= 100;  // Über 0% Profit

                let colorClass = isJackpot ? 'text-jackpot' : (isProfit ? 'text-profit' : 'text-loss');
                let jackpotBadge = isJackpot ? '<span class="badge bg-danger ms-2">JACKPOT</span>' : '';

                // HTML Struktur (Klassisch / Original)
                let html = `
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0">${res.inputName} ${jackpotBadge}</h5>
                        <div class="text-end">
                            <div style="font-size: 0.8em; color:#888;">Yield</div>
                            <div class="${colorClass}" style="font-size: 1.2em;">${res.roi.toFixed(2)}%</div>
                        </div>
                    </div>
                    
                    <div class="row mb-2" style="font-size: 0.9em;">
                        <div class="col-6">Cost: <b>${res.cost.toFixed(2)}€</b></div>
                        <div class="col-6 text-end">EV: <b>${res.ev.toFixed(2)}€</b></div>
                    </div>

                    <div style="background: #252525; padding: 10px; border-radius: 5px;">
                        ${res.outcomes.map(o => `
                            <div class="d-flex justify-content-between outcome-row">
                                <span>${o.name}</span>
                                <span class="${o.price > res.cost ? 'text-success' : 'text-muted'}">${o.price.toFixed(2)}€</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                `;
                container.innerHTML += html;
            });
        }

        function nextRarity(rarity) {
            const rarities = ["Consumer Grade", "Industrial Grade", "Mil-Spec Grade", "Restricted", "Classified", "Covert"];
            let idx = rarities.indexOf(rarity);
            return (idx >= 0 && idx < rarities.length - 1) ? rarities[idx + 1] : null;
        }

        function getCondition(floatVal) {
            if(floatVal < 0.07) return "Factory New";
            if(floatVal < 0.15) return "Minimal Wear";
            if(floatVal < 0.38) return "Field-Tested";
            if(floatVal < 0.45) return "Well-Worn";
            return "Battle-Scarred";
        }
    </script>
</body>
</html>
